<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사주 PDF 분석 봇 (CRT Style)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">

    <script src="config.js"></script>

    <style>
        /* --- Basic CRT Styling (Mostly Unchanged) --- */
        body {
            color: #00ff00;
            font-family: 'Lucida Console', 'Courier New', monospace;
            margin: 0; padding: 0;
            background-color: #000000;
            background-image: url('matrix.png');
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            font-size: 15px; /* Slightly smaller base font */
        }
        .crt-container {
            border: 8px solid #00cc00; /* Slightly darker green */
            border-radius: 4px;
            box-sizing: border-box;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.85); /* More opaque */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .chat-box {
            border: 1px solid #00cc00;
            background-color: rgba(0, 0, 0, 0.1);
            flex-grow: 1;
            min-height: 300px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .chat-box::-webkit-scrollbar { width: 8px; }
        .chat-box::-webkit-scrollbar-track { background-color: #001a00; }
        .chat-box::-webkit-scrollbar-thumb { background-color: #00cc00; border: 1px solid #001a00; }

        .user-message,
        .bot-message {
            max-width: 80%;
            margin-bottom: 10px;
            border: 1px solid #00cc00;
            border-radius: 6px;
            padding: 10px 14px;
            color: #00ff00;
            word-break: break-word;
            line-height: 1.6;
            background-color: #001000; /* Darker background for messages */
        }
        .user-message {
             margin-left: auto; margin-right: 0;
             background-color: #001f00; /* Slightly different user bg */
        }
        .bot-message {
            margin-left: 0; margin-right: auto;
        }
        .bot-message strong { color: #80ff80; } /* Highlight bold text */
        .bot-message code { background-color: #002a00; padding: 2px 4px; border-radius: 3px; }

        .file-input-container,
        .chat-input-container {
            border-top: 1px solid #00cc00;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            gap: 10px; /* Spacing between elements */
        }
        .file-input-container {
             border-top: none; /* No top border for file input */
             padding-top: 0;
             font-size: 0.9rem;
        }

        /* Style the file input button */
        input[type="file"] {
            display: none; /* Hide the default file input */
        }
        .file-upload-label {
            background-color: #000000;
            color: #00ff00;
            font-family: inherit;
            border: 1px solid #00ff00;
            padding: 8px 12px;
            cursor: pointer;
            transition: opacity 0.2s;
            white-space: nowrap;
        }
        .file-upload-label:hover { opacity: 0.8; }
        #selected-file-name {
             color: #80ff80; /* Lighter green for filename */
             overflow: hidden;
             white-space: nowrap;
             text-overflow: ellipsis;
             flex-grow: 1; /* Take remaining space */
        }
         #selected-file-name.error { color: #ff4d4d; } /* Red for errors */

        .chat-input {
            background-color: #000000;
            color: #00ff00;
            font-family: inherit;
            border: 1px solid #00ff00;
            padding: 10px;
            flex-grow: 1;
            outline: none;
            box-sizing: border-box;
        }
        .chat-send-button {
            background-color: #000000;
            color: #00ff00;
            font-family: inherit;
            border: 1px solid #00ff00;
            padding: 10px 15px;
            cursor: pointer;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }
        .chat-send-button:hover { opacity: 0.8; }
        .chat-send-button:disabled { opacity: 0.4; cursor: not-allowed; }

        /* --- Status UI (Simplified) --- */
        #status-container {
            border: 1px dashed #00cc00;
            padding: 6px 10px;
            margin-bottom: 10px;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            color: #00ff00;
            font-size: 0.9rem;
        }
        #status-container .status-icon {
            width: 20px;
            text-align: center;
            margin-right: 0.7rem;
            animation: spin 1.5s linear infinite;
        }
         /* Use FontAwesome spinner */
        #status-container .status-icon .fas { font-size: 1.1em; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
             margin-top: 10px; /* Add space above footer */
             padding-top: 5px;
             border-top: 1px solid #003300; /* Subtle top border */
             text-align: center;
             font-size: 0.8rem;
             color: #008000; /* Darker green for footer */
        }

        /* Print styles */
        @media print { /* ... (print styles unchanged) ... */ }
    </style>
</head>

<body>
<div class="container mx-auto px-4 py-4 max-w-5xl crt-container">
    <h1 class="text-2xl mb-4 text-center" style="color:#00ff00;">사주 PDF 분석 봇</h1>

    <div id="chat-box" class="chat-box">
        <div class="bot-message">
            분석할 사주 관련 PDF 파일을 선택하고, 파일 내용에 대해 질문해주세요.
            <br><strong style="color: #ff4d4d;">🚨 경고: 이 데모는 API 키를 브라우저에 노출시킵니다. 실제 환경에서는 절대 사용하지 마세요!</strong>
        </div>
    </div>

    <div class="file-input-container no-print">
         <input type="file" id="pdf-input" accept=".pdf" />
         <label for="pdf-input" class="file-upload-label"><i class="fas fa-file-pdf"></i> PDF 선택</label>
         <span id="selected-file-name">선택된 파일 없음</span>
     </div>

    <div class="chat-input-container no-print">
        <input type="text" id="user-input" class="chat-input" placeholder="PDF 파일 내용을 바탕으로 질문해주세요...">
        <button id="send-button" class="chat-send-button" disabled>Send</button> </div>

    <div class="footer no-print">
         © 사주 고인물 PDF 에디션 (데모 버전 - 보안 주의)
    </div>
</div>

<script>
/* ======== CONFIG & BASIC SETUP ======== */
const DEBUG = true;
function log(...args) {
    if (DEBUG) {
        console.log(`[PDF Bot Log ${new Date().toLocaleTimeString()}]`, ...args);
    }
}

// --- Security Warning ---
console.warn("🚨 SECURITY WARNING: Gemini API Key is exposed in client-side JavaScript. DO NOT USE IN PRODUCTION. Consider using a backend proxy.");
alert("🚨 보안 경고: Gemini API 키가 클라이언트 측 코드에 노출될 수 있습니다. 이 데모는 학습 목적으로만 사용하고, 실제 서비스에는 절대 적용하지 마십시오. 백엔드 서버를 사용하는 것이 안전합니다.");


// Get Gemini API Key from config.js
const geminiApiKey = window.apiKeys?.GEMINI_API_KEY;

if (!geminiApiKey) {
    console.error("Gemini API Key is not set in config.js");
    const errorDiv = document.createElement('div');
    errorDiv.className = 'bot-message error-message'; // You might need an .error-message style
    errorDiv.style.color = '#ff4d4d';
    errorDiv.innerHTML = '<strong>치명적 오류:</strong> Gemini API 키가 설정되지 않았습니다. config.js 파일을 확인하세요.';
    document.getElementById('chat-box').appendChild(errorDiv);
    throw new Error("Missing Gemini API Key"); // Stop execution
}

// --- Global Variable for Selected File ---
let selectedPdfFile = null;
let uploadedFileUri = null; // Store the URI after successful upload

// DOM Elements
const chatBox = document.getElementById('chat-box');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');
const pdfInput = document.getElementById('pdf-input');
const selectedFileNameSpan = document.getElementById('selected-file-name');
const chatInputContainer = document.querySelector('.chat-input-container');


// --- Message Display Functions ---
function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function addUserMessage(text) {
    const div = document.createElement('div');
    div.className = 'user-message';
    div.textContent = text; // Use textContent for user input
    chatBox.appendChild(div);
    scrollToBottom();
}

function addBotMessage(htmlContent) {
    removeStatusUI();
    const div = document.createElement('div');
    div.className = 'bot-message';
    // Basic sanitization
    const sanitized = htmlContent.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
    div.innerHTML = sanitized; // Use innerHTML for bot response (can contain formatting)
    chatBox.appendChild(div);
    scrollToBottom();
    return div;
}

function addErrorMessage(message) {
     removeStatusUI();
     const div = document.createElement('div');
     div.className = 'bot-message'; // Style like a bot message
     div.style.color = '#ff4d4d'; // Red color for errors
     div.innerHTML = `<strong>오류:</strong> ${escapeHtml(message)}`;
     chatBox.appendChild(div);
     scrollToBottom();
}

function scrollToBottom() {
    // Add a slight delay to ensure the DOM has updated before scrolling
    setTimeout(() => {
        chatBox.scrollTop = chatBox.scrollHeight;
    }, 50);
}

// --- Status UI ---
function createStatusUI(message = "처리 중...") {
    removeStatusUI();
    const container = document.createElement('div');
    container.id = 'status-container';
    container.innerHTML = `
        <span class="status-icon"><i class="fas fa-spinner fa-spin"></i></span>
        <span class="status-label">${escapeHtml(message)}</span>
    `;
    // Insert status UI *before* the file input container
    const fileInputContainer = document.querySelector('.file-input-container');
    fileInputContainer.parentNode.insertBefore(container, fileInputContainer);
    scrollToBottom();
}

function removeStatusUI() {
    const el = document.getElementById('status-container');
    if (el) el.remove();
}

// --- Loading State ---
function setLoadingState(isLoading, statusMessage = "처리 중...") {
    userInput.disabled = isLoading;
    sendButton.disabled = isLoading || !selectedPdfFile; // Disable if loading or no file selected
    pdfInput.disabled = isLoading; // Disable file input during processing

    // Also disable the file input label visually
    const fileLabel = document.querySelector('.file-upload-label');
     if (fileLabel) {
         fileLabel.style.opacity = isLoading ? '0.5' : '1';
         fileLabel.style.cursor = isLoading ? 'not-allowed' : 'pointer';
     }

    if (isLoading) {
        createStatusUI(statusMessage);
    } else {
        removeStatusUI();
        if (!userInput.disabled) {
             userInput.focus(); // Only focus if not disabled
        }
    }
    scrollToBottom();
}

/* ======== PDF File Handling ======== */
pdfInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        if (file.type === "application/pdf") {
            selectedPdfFile = file;
            selectedFileNameSpan.textContent = `선택됨: ${file.name}`;
            selectedFileNameSpan.className = ''; // Reset class name
            sendButton.disabled = false; // Enable send button
            uploadedFileUri = null; // Reset URI when a new file is selected
            log(`PDF file selected: ${file.name}, Size: ${file.size} bytes`);
            addBotMessage(`"${file.name}" 파일이 선택되었습니다. 이제 질문을 입력하세요.`);
        } else {
            selectedPdfFile = null;
            selectedFileNameSpan.textContent = "오류: PDF 파일만 선택 가능합니다.";
            selectedFileNameSpan.className = 'error';
            sendButton.disabled = true;
            uploadedFileUri = null;
            addErrorMessage("PDF 파일 형식이 아닙니다. 다시 선택해주세요.");
        }
    } else {
        selectedPdfFile = null;
        selectedFileNameSpan.textContent = "선택된 파일 없음";
        selectedFileNameSpan.className = '';
        sendButton.disabled = true;
        uploadedFileUri = null;
        log("File selection cancelled or no file chosen.");
    }
     // Clear the input value so the 'change' event fires even if the same file is selected again
     event.target.value = null;
});


/* ======== GEMINI API INTERACTION (using REST API) ======== */

// **Function to Upload PDF using REST API**
async function uploadPdfToGemini(file) {
    if (!file) return null;

    log(`Uploading PDF: ${file.name}`);
    setLoadingState(true, `PDF 업로드 중: ${file.name}...`);

    const uploadUrl = `https://generativelanguage.googleapis.com/v1beta/files?key=${geminiApiKey}`;

    try {
        // --- Simple Upload (for files < 20MB, adjust if needed) ---
        // For larger files, resumable uploads are necessary, which is much more complex.
        const response = await fetch(uploadUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/pdf',
                'X-Goog-Upload-Protocol': 'raw' // Indicate simple upload
                // 'X-Goog-Upload-File-Name': file.name // Optional: provide filename hint
            },
            body: file // Send the file object directly
        });

        const data = await response.json();

        if (!response.ok || data.error) {
            throw new Error(`File API Error: ${data.error?.message || `HTTP ${response.status}`}`);
        }

        if (!data.file || !data.file.uri) {
            throw new Error("File API Error: Upload response did not contain file URI.");
        }

        log(`PDF Uploaded Successfully. URI: ${data.file.uri}`);
        // Store the URI globally for later use in generateContent
        uploadedFileUri = data.file.uri;
        return uploadedFileUri;

        // Note: We are NOT polling for 'ACTIVE' state here.
        // We assume generateContent will wait or handle it.
        // If requests fail, polling might need to be added.

    } catch (error) {
        log('PDF Upload Error:', error);
        addErrorMessage(`PDF 파일 업로드 실패: ${error.message}. CORS 정책 또는 API 키 문제를 확인하세요.`);
        uploadedFileUri = null; // Clear URI on error
        return null; // Indicate failure
    } finally {
         // Keep loading state until generateContent finishes or fails
         // setLoadingState(false); // Don't turn off loading yet
    }
}

// **Function to get response based on uploaded PDF and question**
async function getGeminiResponsePdf(question, fileUri) {
    if (!geminiApiKey) {
        return "오류: Gemini API 키가 누락되었습니다.";
    }
    if (!fileUri) {
        return "오류: PDF 파일 URI가 없습니다. 파일이 성공적으로 업로드되었는지 확인하세요.";
    }

    log(`Sending request to Gemini with PDF URI: ${fileUri} and Question: ${question}`);
    setLoadingState(true, "Gemini 분석 중..."); // Update status

    // --- Prepare the Prompt for PDF context ---
    // The prompt now references the file URI instead of embedding text.
    const systemPrompt = `당신은 PDF 문서의 내용을 바탕으로 사용자의 질문에 한국어로 답변하는 AI 어시스턴트입니다.
- 제공된 PDF 파일("fileData")의 내용을 분석하고 사용자의 질문("text")에 답하세요.
- 답변은 반드시 PDF 파일 내의 정보에 근거해야 합니다. 파일에 없는 내용은 답변하지 마세요.
- 답변은 명확하고 간결하게, 전문가적인 톤으로 작성해주세요.
- Markdown 형식을 사용하여 가독성을 높일 수 있습니다(굵게, 기울임, 목록 등).`;

    // --- API Request Body (with File Reference) ---
    const reqBody = {
        contents: [{
            role: "user",
            parts: [
                // 1. User's question
                { text: `${systemPrompt}\n\n질문: ${question}` },
                 // 2. Reference to the uploaded PDF file
                 {
                     fileData: {
                         mimeType: "application/pdf",
                         fileUri: fileUri // Use the URI obtained from the upload response
                     }
                 }
             ]
        }],
        safetySettings: [ // Standard safety settings
             { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
             { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
             { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
             { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
         ],
        generationConfig: {
            temperature: 0.6, // Adjust temperature as needed
            // maxOutputTokens: 2048, // Optional token limit
        }
    };

    // --- Define Model and URL ---
    // Use a model that supports File API and PDF processing (e.g., 1.5 Flash or Pro)
    const model = "gemini-1.5-flash-latest"; // Or gemini-1.5-pro-latest
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${geminiApiKey}`;

    // --- Fetch API ---
    try {
        const resp = await fetch(url, {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(reqBody)
        });

        const data = await resp.json();

        // --- Error Handling (more detailed) ---
        if (!resp.ok || data.error) {
            let errorDetail = data.error ? `Code ${data.error.code}: ${data.error.message}` : `HTTP ${resp.status}`;
            if (data.error?.details) {
                 errorDetail += ` Details: ${JSON.stringify(data.error.details)}`;
             }
            if (errorDetail.includes("API key not valid")) {
                errorDetail = "잘못된 Gemini API 키입니다. config.js를 확인하세요.";
            } else if (resp.status === 400 && errorDetail.includes("File processing failed")) {
                errorDetail = "PDF 파일 처리 실패. 파일이 손상되었거나 지원되지 않는 형식일 수 있습니다.";
            } else if (resp.status === 400 && errorDetail.includes("not found")) {
                 errorDetail = "참조된 PDF 파일 URI를 찾을 수 없습니다. 업로드가 성공했는지 확인하세요.";
             }
             else if (resp.status === 429) {
                 errorDetail = "API 요청 할당량이 초과되었습니다. 잠시 후 다시 시도하세요.";
             }
            throw new Error(`Gemini API 오류: ${errorDetail}`);
        }

         // Check for empty or blocked response
         if (!data.candidates || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0].text) {
             let reason = "알 수 없는 이유.";
             if (data.candidates && data.candidates[0].finishReason) {
                 reason = `종료 이유: ${data.candidates[0].finishReason}`;
                 if (data.candidates[0].safetyRatings) {
                     reason += ` 안전 등급: ${JSON.stringify(data.candidates[0].safetyRatings)}`;
                 }
             }
             if (data.promptFeedback && data.promptFeedback.blockReason) {
                  reason = `프롬프트 차단됨: ${data.promptFeedback.blockReason}`;
             }
             log("Gemini 응답 내용 누락 또는 차단됨. 이유:", reason, "전체 응답:", data);
             return `오류: Gemini로부터 비어 있거나 차단된 응답을 받았습니다. 이유: ${reason}`;
         }

        let answer = data.candidates[0].content.parts[0].text;
        log("Gemini로부터 PDF 기반 응답 수신 완료.");

        // --- Basic Markdown to HTML Conversion ---
         answer = answer
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/^\s*[\-\*]\s+(.*)/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>\s*)+/g, '<ul>$&</ul>')
            .replace(/^###+\s+(.*)/gm, '<h5>$1</h5>')
            .replace(/^##\s+(.*)/gm, '<h4>$1</h4>')
            .replace(/^#\s+(.*)/gm, '<h3>$1</h3>')
            .replace(/\n/g, '<br>')
            .replace(/<\/ul><br>/g, '</ul>')
            .replace(/<br><ul>/g, '<ul>')
            .replace(/<li><br>/g, '<li>')
            .replace(/<br><\/li>/g, '</li>');

        return answer;

    } catch (err) {
        log('Gemini API fetch error:', err);
        addErrorMessage(`Gemini 통신 오류: ${err.message}`);
        return null; // Indicate failure to the caller
    } finally {
         // Turn off loading state after attempt, regardless of success/failure
         // setLoadingState(false); // Let processMessage handle the final state
    }
}

/* ======== MAIN MESSAGE PROCESSING ======== */
async function processMessage() {
    const userQuestion = userInput.value.trim();
    if (!userQuestion) return;

    if (!selectedPdfFile) {
        addErrorMessage("질문하기 전에 먼저 PDF 파일을 선택해주세요.");
        return;
    }

    addUserMessage(userQuestion);
    userInput.value = ''; // Clear input after adding message
    userInput.blur(); // Hide keyboard on mobile

    setLoadingState(true, "작업 초기화 중...");

    try {
        // 1. Upload PDF (only if not already uploaded or if file changed)
        // We currently re-upload each time for simplicity, assuming file URI might expire or change.
        // A more optimized approach would cache the URI based on the file content/name/size.
        const currentFileUri = await uploadPdfToGemini(selectedPdfFile);

        if (!currentFileUri) {
            // Error message already shown by uploadPdfToGemini
            setLoadingState(false); // Stop loading indicator
            return; // Stop processing
        }

        // 2. Get Response from Gemini using the uploaded file URI
        const botResponse = await getGeminiResponsePdf(userQuestion, currentFileUri);

        // 3. Display Response (or error if botResponse is null/error string)
        if (botResponse && !botResponse.startsWith("오류:")) {
             addBotMessage(botResponse);
        } else if (botResponse) {
             // Error message already formatted within botResponse string
             addErrorMessage(botResponse.replace(/^오류:\s*/, '')); // Display as error
        }
         // If botResponse was null due to fetch error, addErrorMessage was already called in getGeminiResponsePdf

    } catch (error) {
         // Catch any unexpected errors during the process
         log("Unexpected error in processMessage:", error);
         addErrorMessage(`처리 중 예상치 못한 오류 발생: ${error.message}`);
    } finally {
        // 4. Reset Loading State
        setLoadingState(false);
    }
}

/* ======== EVENT LISTENERS ======== */
function handleSend() {
    const msg = userInput.value.trim();
    // Check if not loading AND a file is selected AND there's a message
    if (!sendButton.disabled && selectedPdfFile && msg) {
        processMessage();
    } else if (!selectedPdfFile) {
         addErrorMessage("먼저 PDF 파일을 선택해야 합니다.");
    } else if (!msg) {
         addErrorMessage("질문을 입력해주세요.");
    }
}

sendButton.addEventListener('click', handleSend);

userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // Prevent default newline
        handleSend();
    }
});

// --- Initial Setup ---
userInput.focus();
log('PDF 분석 봇 초기화 완료. PDF 파일을 선택하고 질문해주세요.');
// Initial message already added in HTML

</script>
</body>
</html>
