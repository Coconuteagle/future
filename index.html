<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì£¼ PDF ë¶„ì„ ë´‡ (CRT Style)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">

    <script src="config.js"></script>

    <style>
        /* --- Basic CRT Styling (Mostly Unchanged) --- */
        body {
            color: #00ff00;
            font-family: 'Lucida Console', 'Courier New', monospace;
            margin: 0; padding: 0;
            background-color: #000000;
            background-image: url('matrix.png');
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            font-size: 15px; /* Slightly smaller base font */
        }
        .crt-container {
            border: 8px solid #00cc00; /* Slightly darker green */
            border-radius: 4px;
            box-sizing: border-box;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.85); /* More opaque */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .chat-box {
            border: 1px solid #00cc00;
            background-color: rgba(0, 0, 0, 0.1);
            flex-grow: 1;
            min-height: 300px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .chat-box::-webkit-scrollbar { width: 8px; }
        .chat-box::-webkit-scrollbar-track { background-color: #001a00; }
        .chat-box::-webkit-scrollbar-thumb { background-color: #00cc00; border: 1px solid #001a00; }

        .user-message,
        .bot-message {
            max-width: 80%;
            margin-bottom: 10px;
            border: 1px solid #00cc00;
            border-radius: 6px;
            padding: 10px 14px;
            color: #00ff00;
            word-break: break-word;
            line-height: 1.6;
            background-color: #001000; /* Darker background for messages */
        }
        .user-message {
             margin-left: auto; margin-right: 0;
             background-color: #001f00; /* Slightly different user bg */
        }
        .bot-message {
            margin-left: 0; margin-right: auto;
        }
        .bot-message strong { color: #80ff80; } /* Highlight bold text */
        .bot-message code { background-color: #002a00; padding: 2px 4px; border-radius: 3px; }

        .file-input-container,
        .chat-input-container {
            border-top: 1px solid #00cc00;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            gap: 10px; /* Spacing between elements */
        }
        .file-input-container {
             border-top: none; /* No top border for file input */
             padding-top: 0;
             font-size: 0.9rem;
        }

        /* Style the file input button */
        input[type="file"] {
            display: none; /* Hide the default file input */
        }
        .file-upload-label {
            background-color: #000000;
            color: #00ff00;
            font-family: inherit;
            border: 1px solid #00ff00;
            padding: 8px 12px;
            cursor: pointer;
            transition: opacity 0.2s;
            white-space: nowrap;
        }
        .file-upload-label:hover { opacity: 0.8; }
        #selected-file-name {
             color: #80ff80; /* Lighter green for filename */
             overflow: hidden;
             white-space: nowrap;
             text-overflow: ellipsis;
             flex-grow: 1; /* Take remaining space */
        }
         #selected-file-name.error { color: #ff4d4d; } /* Red for errors */

        .chat-input {
            background-color: #000000;
            color: #00ff00;
            font-family: inherit;
            border: 1px solid #00ff00;
            padding: 10px;
            flex-grow: 1;
            outline: none;
            box-sizing: border-box;
        }
        .chat-send-button {
            background-color: #000000;
            color: #00ff00;
            font-family: inherit;
            border: 1px solid #00ff00;
            padding: 10px 15px;
            cursor: pointer;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }
        .chat-send-button:hover { opacity: 0.8; }
        .chat-send-button:disabled { opacity: 0.4; cursor: not-allowed; }

        /* --- Status UI (Simplified) --- */
        #status-container {
            border: 1px dashed #00cc00;
            padding: 6px 10px;
            margin-bottom: 10px;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            color: #00ff00;
            font-size: 0.9rem;
        }
        #status-container .status-icon {
            width: 20px;
            text-align: center;
            margin-right: 0.7rem;
            animation: spin 1.5s linear infinite;
        }
         /* Use FontAwesome spinner */
        #status-container .status-icon .fas { font-size: 1.1em; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
             margin-top: 10px; /* Add space above footer */
             padding-top: 5px;
             border-top: 1px solid #003300; /* Subtle top border */
             text-align: center;
             font-size: 0.8rem;
             color: #008000; /* Darker green for footer */
        }

        /* Print styles */
        @media print { /* ... (print styles unchanged) ... */ }
    </style>
</head>

<body>
<div class="container mx-auto px-4 py-4 max-w-5xl crt-container">
    <h1 class="text-2xl mb-4 text-center" style="color:#00ff00;">ì‚¬ì£¼ PDF ë¶„ì„ ë´‡</h1>

    <div id="chat-box" class="chat-box">
        <div class="bot-message">
            ë¶„ì„í•  ì‚¬ì£¼ ê´€ë ¨ PDF íŒŒì¼ì„ ì„ íƒí•˜ê³ , íŒŒì¼ ë‚´ìš©ì— ëŒ€í•´ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.
            <br><strong style="color: #ff4d4d;">ğŸš¨ ê²½ê³ : ì´ ë°ëª¨ëŠ” API í‚¤ë¥¼ ë¸Œë¼ìš°ì €ì— ë…¸ì¶œì‹œí‚µë‹ˆë‹¤. ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”!</strong>
        </div>
    </div>

    <div class="file-input-container no-print">
         <input type="file" id="pdf-input" accept=".pdf" />
         <label for="pdf-input" class="file-upload-label"><i class="fas fa-file-pdf"></i> PDF ì„ íƒ</label>
         <span id="selected-file-name">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
     </div>

    <div class="chat-input-container no-print">
        <input type="text" id="user-input" class="chat-input" placeholder="PDF íŒŒì¼ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”...">
        <button id="send-button" class="chat-send-button" disabled>Send</button> </div>

    <div class="footer no-print">
         Â© ì‚¬ì£¼ ê³ ì¸ë¬¼ PDF ì—ë””ì…˜ (ë°ëª¨ ë²„ì „ - ë³´ì•ˆ ì£¼ì˜)
    </div>
</div>

<script>
/* ======== CONFIG & BASIC SETUP ======== */
const DEBUG = true;
function log(...args) {
    if (DEBUG) {
        console.log(`[PDF Bot Log ${new Date().toLocaleTimeString()}]`, ...args);
    }
}

// --- Security Warning ---
console.warn("ğŸš¨ SECURITY WARNING: Gemini API Key is exposed in client-side JavaScript. DO NOT USE IN PRODUCTION. Consider using a backend proxy.");
alert("ğŸš¨ ë³´ì•ˆ ê²½ê³ : Gemini API í‚¤ê°€ í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì½”ë“œì— ë…¸ì¶œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë°ëª¨ëŠ” í•™ìŠµ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ê³ , ì‹¤ì œ ì„œë¹„ìŠ¤ì—ëŠ” ì ˆëŒ€ ì ìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤. ë°±ì—”ë“œ ì„œë²„ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.");


// Get Gemini API Key from config.js
const geminiApiKey = window.apiKeys?.GEMINI_API_KEY;

if (!geminiApiKey) {
    console.error("Gemini API Key is not set in config.js");
    const errorDiv = document.createElement('div');
    errorDiv.className = 'bot-message error-message'; // You might need an .error-message style
    errorDiv.style.color = '#ff4d4d';
    errorDiv.innerHTML = '<strong>ì¹˜ëª…ì  ì˜¤ë¥˜:</strong> Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. config.js íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.';
    document.getElementById('chat-box').appendChild(errorDiv);
    throw new Error("Missing Gemini API Key"); // Stop execution
}

// --- Global Variable for Selected File ---
let selectedPdfFile = null;
let uploadedFileUri = null; // Store the URI after successful upload

// DOM Elements
const chatBox = document.getElementById('chat-box');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');
const pdfInput = document.getElementById('pdf-input');
const selectedFileNameSpan = document.getElementById('selected-file-name');
const chatInputContainer = document.querySelector('.chat-input-container');


// --- Message Display Functions ---
function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function addUserMessage(text) {
    const div = document.createElement('div');
    div.className = 'user-message';
    div.textContent = text; // Use textContent for user input
    chatBox.appendChild(div);
    scrollToBottom();
}

function addBotMessage(htmlContent) {
    removeStatusUI();
    const div = document.createElement('div');
    div.className = 'bot-message';
    // Basic sanitization
    const sanitized = htmlContent.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
    div.innerHTML = sanitized; // Use innerHTML for bot response (can contain formatting)
    chatBox.appendChild(div);
    scrollToBottom();
    return div;
}

function addErrorMessage(message) {
     removeStatusUI();
     const div = document.createElement('div');
     div.className = 'bot-message'; // Style like a bot message
     div.style.color = '#ff4d4d'; // Red color for errors
     div.innerHTML = `<strong>ì˜¤ë¥˜:</strong> ${escapeHtml(message)}`;
     chatBox.appendChild(div);
     scrollToBottom();
}

function scrollToBottom() {
    // Add a slight delay to ensure the DOM has updated before scrolling
    setTimeout(() => {
        chatBox.scrollTop = chatBox.scrollHeight;
    }, 50);
}

// --- Status UI ---
function createStatusUI(message = "ì²˜ë¦¬ ì¤‘...") {
    removeStatusUI();
    const container = document.createElement('div');
    container.id = 'status-container';
    container.innerHTML = `
        <span class="status-icon"><i class="fas fa-spinner fa-spin"></i></span>
        <span class="status-label">${escapeHtml(message)}</span>
    `;
    // Insert status UI *before* the file input container
    const fileInputContainer = document.querySelector('.file-input-container');
    fileInputContainer.parentNode.insertBefore(container, fileInputContainer);
    scrollToBottom();
}

function removeStatusUI() {
    const el = document.getElementById('status-container');
    if (el) el.remove();
}

// --- Loading State ---
function setLoadingState(isLoading, statusMessage = "ì²˜ë¦¬ ì¤‘...") {
    userInput.disabled = isLoading;
    sendButton.disabled = isLoading || !selectedPdfFile; // Disable if loading or no file selected
    pdfInput.disabled = isLoading; // Disable file input during processing

    // Also disable the file input label visually
    const fileLabel = document.querySelector('.file-upload-label');
     if (fileLabel) {
         fileLabel.style.opacity = isLoading ? '0.5' : '1';
         fileLabel.style.cursor = isLoading ? 'not-allowed' : 'pointer';
     }

    if (isLoading) {
        createStatusUI(statusMessage);
    } else {
        removeStatusUI();
        if (!userInput.disabled) {
             userInput.focus(); // Only focus if not disabled
        }
    }
    scrollToBottom();
}

/* ======== PDF File Handling ======== */
pdfInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        if (file.type === "application/pdf") {
            selectedPdfFile = file;
            selectedFileNameSpan.textContent = `ì„ íƒë¨: ${file.name}`;
            selectedFileNameSpan.className = ''; // Reset class name
            sendButton.disabled = false; // Enable send button
            uploadedFileUri = null; // Reset URI when a new file is selected
            log(`PDF file selected: ${file.name}, Size: ${file.size} bytes`);
            addBotMessage(`"${file.name}" íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.`);
        } else {
            selectedPdfFile = null;
            selectedFileNameSpan.textContent = "ì˜¤ë¥˜: PDF íŒŒì¼ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
            selectedFileNameSpan.className = 'error';
            sendButton.disabled = true;
            uploadedFileUri = null;
            addErrorMessage("PDF íŒŒì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.");
        }
    } else {
        selectedPdfFile = null;
        selectedFileNameSpan.textContent = "ì„ íƒëœ íŒŒì¼ ì—†ìŒ";
        selectedFileNameSpan.className = '';
        sendButton.disabled = true;
        uploadedFileUri = null;
        log("File selection cancelled or no file chosen.");
    }
     // Clear the input value so the 'change' event fires even if the same file is selected again
     event.target.value = null;
});


/* ======== GEMINI API INTERACTION (using REST API) ======== */

// **Function to Upload PDF using REST API**
async function uploadPdfToGemini(file) {
    if (!file) return null;

    log(`Uploading PDF: ${file.name}`);
    setLoadingState(true, `PDF ì—…ë¡œë“œ ì¤‘: ${file.name}...`);

    const uploadUrl = `https://generativelanguage.googleapis.com/v1beta/files?key=${geminiApiKey}`;

    try {
        // --- Simple Upload (for files < 20MB, adjust if needed) ---
        // For larger files, resumable uploads are necessary, which is much more complex.
        const response = await fetch(uploadUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/pdf',
                'X-Goog-Upload-Protocol': 'raw' // Indicate simple upload
                // 'X-Goog-Upload-File-Name': file.name // Optional: provide filename hint
            },
            body: file // Send the file object directly
        });

        const data = await response.json();

        if (!response.ok || data.error) {
            throw new Error(`File API Error: ${data.error?.message || `HTTP ${response.status}`}`);
        }

        if (!data.file || !data.file.uri) {
            throw new Error("File API Error: Upload response did not contain file URI.");
        }

        log(`PDF Uploaded Successfully. URI: ${data.file.uri}`);
        // Store the URI globally for later use in generateContent
        uploadedFileUri = data.file.uri;
        return uploadedFileUri;

        // Note: We are NOT polling for 'ACTIVE' state here.
        // We assume generateContent will wait or handle it.
        // If requests fail, polling might need to be added.

    } catch (error) {
        log('PDF Upload Error:', error);
        addErrorMessage(`PDF íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}. CORS ì •ì±… ë˜ëŠ” API í‚¤ ë¬¸ì œë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
        uploadedFileUri = null; // Clear URI on error
        return null; // Indicate failure
    } finally {
         // Keep loading state until generateContent finishes or fails
         // setLoadingState(false); // Don't turn off loading yet
    }
}

// **Function to get response based on uploaded PDF and question**
async function getGeminiResponsePdf(question, fileUri) {
    if (!geminiApiKey) {
        return "ì˜¤ë¥˜: Gemini API í‚¤ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.";
    }
    if (!fileUri) {
        return "ì˜¤ë¥˜: PDF íŒŒì¼ URIê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.";
    }

    log(`Sending request to Gemini with PDF URI: ${fileUri} and Question: ${question}`);
    setLoadingState(true, "Gemini ë¶„ì„ ì¤‘..."); // Update status

    // --- Prepare the Prompt for PDF context ---
    // The prompt now references the file URI instead of embedding text.
    const systemPrompt = `ë‹¹ì‹ ì€ PDF ë¬¸ì„œì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— í•œêµ­ì–´ë¡œ ë‹µë³€í•˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
- ì œê³µëœ PDF íŒŒì¼("fileData")ì˜ ë‚´ìš©ì„ ë¶„ì„í•˜ê³  ì‚¬ìš©ìì˜ ì§ˆë¬¸("text")ì— ë‹µí•˜ì„¸ìš”.
- ë‹µë³€ì€ ë°˜ë“œì‹œ PDF íŒŒì¼ ë‚´ì˜ ì •ë³´ì— ê·¼ê±°í•´ì•¼ í•©ë‹ˆë‹¤. íŒŒì¼ì— ì—†ëŠ” ë‚´ìš©ì€ ë‹µë³€í•˜ì§€ ë§ˆì„¸ìš”.
- ë‹µë³€ì€ ëª…í™•í•˜ê³  ê°„ê²°í•˜ê²Œ, ì „ë¬¸ê°€ì ì¸ í†¤ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
- Markdown í˜•ì‹ì„ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤(êµµê²Œ, ê¸°ìš¸ì„, ëª©ë¡ ë“±).`;

    // --- API Request Body (with File Reference) ---
    const reqBody = {
        contents: [{
            role: "user",
            parts: [
                // 1. User's question
                { text: `${systemPrompt}\n\nì§ˆë¬¸: ${question}` },
                 // 2. Reference to the uploaded PDF file
                 {
                     fileData: {
                         mimeType: "application/pdf",
                         fileUri: fileUri // Use the URI obtained from the upload response
                     }
                 }
             ]
        }],
        safetySettings: [ // Standard safety settings
             { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
             { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
             { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
             { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
         ],
        generationConfig: {
            temperature: 0.6, // Adjust temperature as needed
            // maxOutputTokens: 2048, // Optional token limit
        }
    };

    // --- Define Model and URL ---
    // Use a model that supports File API and PDF processing (e.g., 1.5 Flash or Pro)
    const model = "gemini-1.5-flash-latest"; // Or gemini-1.5-pro-latest
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${geminiApiKey}`;

    // --- Fetch API ---
    try {
        const resp = await fetch(url, {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(reqBody)
        });

        const data = await resp.json();

        // --- Error Handling (more detailed) ---
        if (!resp.ok || data.error) {
            let errorDetail = data.error ? `Code ${data.error.code}: ${data.error.message}` : `HTTP ${resp.status}`;
            if (data.error?.details) {
                 errorDetail += ` Details: ${JSON.stringify(data.error.details)}`;
             }
            if (errorDetail.includes("API key not valid")) {
                errorDetail = "ì˜ëª»ëœ Gemini API í‚¤ì…ë‹ˆë‹¤. config.jsë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            } else if (resp.status === 400 && errorDetail.includes("File processing failed")) {
                errorDetail = "PDF íŒŒì¼ ì²˜ë¦¬ ì‹¤íŒ¨. íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ ì§€ì›ë˜ì§€ ì•ŠëŠ” í˜•ì‹ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
            } else if (resp.status === 400 && errorDetail.includes("not found")) {
                 errorDetail = "ì°¸ì¡°ëœ PDF íŒŒì¼ URIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì—…ë¡œë“œê°€ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.";
             }
             else if (resp.status === 429) {
                 errorDetail = "API ìš”ì²­ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
             }
            throw new Error(`Gemini API ì˜¤ë¥˜: ${errorDetail}`);
        }

         // Check for empty or blocked response
         if (!data.candidates || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0].text) {
             let reason = "ì•Œ ìˆ˜ ì—†ëŠ” ì´ìœ .";
             if (data.candidates && data.candidates[0].finishReason) {
                 reason = `ì¢…ë£Œ ì´ìœ : ${data.candidates[0].finishReason}`;
                 if (data.candidates[0].safetyRatings) {
                     reason += ` ì•ˆì „ ë“±ê¸‰: ${JSON.stringify(data.candidates[0].safetyRatings)}`;
                 }
             }
             if (data.promptFeedback && data.promptFeedback.blockReason) {
                  reason = `í”„ë¡¬í”„íŠ¸ ì°¨ë‹¨ë¨: ${data.promptFeedback.blockReason}`;
             }
             log("Gemini ì‘ë‹µ ë‚´ìš© ëˆ„ë½ ë˜ëŠ” ì°¨ë‹¨ë¨. ì´ìœ :", reason, "ì „ì²´ ì‘ë‹µ:", data);
             return `ì˜¤ë¥˜: Geminië¡œë¶€í„° ë¹„ì–´ ìˆê±°ë‚˜ ì°¨ë‹¨ëœ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤. ì´ìœ : ${reason}`;
         }

        let answer = data.candidates[0].content.parts[0].text;
        log("Geminië¡œë¶€í„° PDF ê¸°ë°˜ ì‘ë‹µ ìˆ˜ì‹  ì™„ë£Œ.");

        // --- Basic Markdown to HTML Conversion ---
         answer = answer
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/^\s*[\-\*]\s+(.*)/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>\s*)+/g, '<ul>$&</ul>')
            .replace(/^###+\s+(.*)/gm, '<h5>$1</h5>')
            .replace(/^##\s+(.*)/gm, '<h4>$1</h4>')
            .replace(/^#\s+(.*)/gm, '<h3>$1</h3>')
            .replace(/\n/g, '<br>')
            .replace(/<\/ul><br>/g, '</ul>')
            .replace(/<br><ul>/g, '<ul>')
            .replace(/<li><br>/g, '<li>')
            .replace(/<br><\/li>/g, '</li>');

        return answer;

    } catch (err) {
        log('Gemini API fetch error:', err);
        addErrorMessage(`Gemini í†µì‹  ì˜¤ë¥˜: ${err.message}`);
        return null; // Indicate failure to the caller
    } finally {
         // Turn off loading state after attempt, regardless of success/failure
         // setLoadingState(false); // Let processMessage handle the final state
    }
}

/* ======== MAIN MESSAGE PROCESSING ======== */
async function processMessage() {
    const userQuestion = userInput.value.trim();
    if (!userQuestion) return;

    if (!selectedPdfFile) {
        addErrorMessage("ì§ˆë¬¸í•˜ê¸° ì „ì— ë¨¼ì € PDF íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }

    addUserMessage(userQuestion);
    userInput.value = ''; // Clear input after adding message
    userInput.blur(); // Hide keyboard on mobile

    setLoadingState(true, "ì‘ì—… ì´ˆê¸°í™” ì¤‘...");

    try {
        // 1. Upload PDF (only if not already uploaded or if file changed)
        // We currently re-upload each time for simplicity, assuming file URI might expire or change.
        // A more optimized approach would cache the URI based on the file content/name/size.
        const currentFileUri = await uploadPdfToGemini(selectedPdfFile);

        if (!currentFileUri) {
            // Error message already shown by uploadPdfToGemini
            setLoadingState(false); // Stop loading indicator
            return; // Stop processing
        }

        // 2. Get Response from Gemini using the uploaded file URI
        const botResponse = await getGeminiResponsePdf(userQuestion, currentFileUri);

        // 3. Display Response (or error if botResponse is null/error string)
        if (botResponse && !botResponse.startsWith("ì˜¤ë¥˜:")) {
             addBotMessage(botResponse);
        } else if (botResponse) {
             // Error message already formatted within botResponse string
             addErrorMessage(botResponse.replace(/^ì˜¤ë¥˜:\s*/, '')); // Display as error
        }
         // If botResponse was null due to fetch error, addErrorMessage was already called in getGeminiResponsePdf

    } catch (error) {
         // Catch any unexpected errors during the process
         log("Unexpected error in processMessage:", error);
         addErrorMessage(`ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
    } finally {
        // 4. Reset Loading State
        setLoadingState(false);
    }
}

/* ======== EVENT LISTENERS ======== */
function handleSend() {
    const msg = userInput.value.trim();
    // Check if not loading AND a file is selected AND there's a message
    if (!sendButton.disabled && selectedPdfFile && msg) {
        processMessage();
    } else if (!selectedPdfFile) {
         addErrorMessage("ë¨¼ì € PDF íŒŒì¼ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
    } else if (!msg) {
         addErrorMessage("ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    }
}

sendButton.addEventListener('click', handleSend);

userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // Prevent default newline
        handleSend();
    }
});

// --- Initial Setup ---
userInput.focus();
log('PDF ë¶„ì„ ë´‡ ì´ˆê¸°í™” ì™„ë£Œ. PDF íŒŒì¼ì„ ì„ íƒí•˜ê³  ì§ˆë¬¸í•´ì£¼ì„¸ìš”.');
// Initial message already added in HTML

</script>
</body>
</html>
