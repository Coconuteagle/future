<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì£¼ ì§€ì‹ ë´‡ (CRT Style - ìë™ PDF ë¡œë“œ)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">

    <script src="config.js"></script>

    <style>
        /* --- Basic CRT Styling (ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ê±°ì˜ ë™ì¼) --- */
        body {
            color: #00ff00;
            font-family: 'Lucida Console', 'Courier New', monospace;
            margin: 0; padding: 0;
            background-color: #000000;
            background-image: url('matrix.png'); /* ë°°ê²½ ì´ë¯¸ì§€ ê²½ë¡œ í™•ì¸ */
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            font-size: 15px;
        }
        .crt-container {
            border: 8px solid #00cc00;
            border-radius: 4px;
            box-sizing: border-box;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.85);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .chat-box {
            border: 1px solid #00cc00;
            background-color: rgba(0, 0, 0, 0.1);
            flex-grow: 1;
            min-height: 300px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        .chat-box::-webkit-scrollbar { width: 8px; }
        .chat-box::-webkit-scrollbar-track { background-color: #001a00; }
        .chat-box::-webkit-scrollbar-thumb { background-color: #00cc00; border: 1px solid #001a00; }

        .user-message,
        .bot-message {
            max-width: 80%;
            margin-bottom: 10px;
            border: 1px solid #00cc00;
            border-radius: 6px;
            padding: 10px 14px;
            color: #00ff00;
            word-break: break-word;
            line-height: 1.6;
            background-color: #001000;
        }
        .user-message { margin-left: auto; margin-right: 0; background-color: #001f00; }
        .bot-message { margin-left: 0; margin-right: auto; }
        .bot-message strong { color: #80ff80; }
        .bot-message code { background-color: #002a00; padding: 2px 4px; border-radius: 3px; }

        /* íŒŒì¼ ì…ë ¥ ê´€ë ¨ UI ì œê±°ë¨ */

        .chat-input-container {
            border-top: 1px solid #00cc00;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-input {
            background-color: #000000;
            color: #00ff00;
            font-family: inherit;
            border: 1px solid #00ff00;
            padding: 10px;
            flex-grow: 1;
            outline: none;
            box-sizing: border-box;
        }
        .chat-send-button {
            background-color: #000000;
            color: #00ff00;
            font-family: inherit;
            border: 1px solid #00ff00;
            padding: 10px 15px;
            cursor: pointer;
            transition: opacity 0.2s;
            flex-shrink: 0;
        }
        .chat-send-button:hover { opacity: 0.8; }
        .chat-send-button:disabled { opacity: 0.4; cursor: not-allowed; }

        /* --- Status UI --- */
        #status-container {
            border: 1px dashed #00cc00;
            padding: 6px 10px;
            margin-bottom: 10px;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            color: #00ff00;
            font-size: 0.9rem;
        }
        #status-container .status-icon {
            width: 20px;
            text-align: center;
            margin-right: 0.7rem;
            animation: spin 1.5s linear infinite;
        }
        #status-container .status-icon .fas { font-size: 1.1em; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .footer {
             margin-top: 10px;
             padding-top: 5px;
             border-top: 1px solid #003300;
             text-align: center;
             font-size: 0.8rem;
             color: #008000;
        }
        .error-message { color: #ff4d4d !important; /* Important to override other styles */ }
    </style>
</head>

<body>
<div class="container mx-auto px-4 py-4 max-w-5xl crt-container">
    <h1 class="text-2xl mb-4 text-center" style="color:#00ff00;">ì‚¬ì£¼ ê³ ì¸ë¬¼</h1>

    <div id="chat-box" class="chat-box">
        <div class="bot-message">
            ì•ˆë…•í•˜ì„¸ìš”! ì‚¬ì£¼ ê³ ì¸ë¬¼ì…ë‹ˆë‹¤.
            ë¬´ì—‡ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?
            <br><strong class="error-message">ğŸ’¡ ì‹¤í–‰ ì°¸ê³ : ì´ í˜ì´ì§€ëŠ” ì›¹ ì„œë²„ í™˜ê²½ì—ì„œ ì‹¤í–‰ë˜ì–´ì•¼ PDF íŒŒì¼ì„ ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: Python http.server, VS Code Live Server)</strong>
        </div>
    </div>

    <div class="chat-input-container no-print">
        <input type="text" id="user-input" class="chat-input" placeholder="ì‚¬ì£¼ ì§€ì‹ì— ëŒ€í•´ ì§ˆë¬¸í•´ì£¼ì„¸ìš”...">
        <button id="send-button" class="chat-send-button">Send</button> </div>

    <div class="footer no-print">
        Â© ì‚¬ì£¼ ê³ ì¸ë¬¼
    </div>
</div>

<script>
/* ======== CONFIG & BASIC SETUP ======== */
const DEBUG = true;
function log(...args) {
    if (DEBUG) {
        console.log(`[PDF Bot Log ${new Date().toLocaleTimeString()}]`, ...args);
    }
}

// --- Security & Usage Warning ---
console.warn("ğŸš¨ SECURITY WARNING: Gemini API Key is exposed in client-side JavaScript. DO NOT USE IN PRODUCTION. Consider using a backend proxy.");
console.warn("ğŸ’¡ USAGE NOTE: This HTML file must be served via a web server (e.g., `python -m http.server` or VS Code Live Server) for PDF fetching to work. Opening it as a `file:///` will likely fail.");

// *** ì¤‘ìš”: HTML íŒŒì¼ê³¼ ë™ì¼í•œ ë””ë ‰í† ë¦¬ì— ìˆëŠ” PDF íŒŒì¼ì˜ ì´ë¦„ì„ ì§€ì •í•˜ì„¸ìš” ***
const PREDEFINED_PDF_FILENAME = 'saju_knowledge.pdf'; // <--- ì—¬ê¸°ì— PDF íŒŒì¼ ì´ë¦„ ì…ë ¥!

// Get Gemini API Key from config.js
const geminiApiKey = window.apiKeys?.GEMINI_API_KEY;

if (!geminiApiKey) {
    console.error("Gemini API Key is not set in config.js");
    const errorDiv = document.createElement('div');
    errorDiv.className = 'bot-message error-message';
    errorDiv.innerHTML = '<strong>ì¹˜ëª…ì  ì˜¤ë¥˜:</strong> Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. config.js íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.';
    document.getElementById('chat-box').appendChild(errorDiv);
    throw new Error("Missing Gemini API Key");
}

// --- Global Variable for Uploaded File URI ---
let uploadedFileUri = null; // Store the URI after successful upload
let lastUploadedPdfName = null; // Track which PDF name was last uploaded

// DOM Elements
const chatBox = document.getElementById('chat-box');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');
const chatInputContainer = document.querySelector('.chat-input-container');


// --- Message Display Functions ---
function escapeHtml(unsafe) {
  if (typeof unsafe !== 'string') return '';
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function addUserMessage(text) {
  const div = document.createElement('div');
  div.className = 'user-message';
  div.textContent = text;
  chatBox.appendChild(div);
  scrollToBottom();
}

function addBotMessage(htmlContent) {
  log("addBotMessage called with content length:", htmlContent?.length); // <-- ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ë¨
  removeStatusUI();

  const div = document.createElement('div');
  div.className = 'bot-message';
  const sanitized = htmlContent.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
  div.innerHTML = sanitized;

  chatBox.appendChild(div);
  scrollToBottom();
  return div;
}

function addErrorMessage(message) {
    removeStatusUI();
    const div = document.createElement('div');
    div.className = 'bot-message error-message';
    div.innerHTML = `<strong>ì˜¤ë¥˜:</strong> ${escapeHtml(message)}`;
    chatBox.appendChild(div);
    scrollToBottom();
}

function scrollToBottom() {
    setTimeout(() => {
       chatBox.scrollTop = chatBox.scrollHeight;
    }, 50);
}

// --- Status UI ---
function createStatusUI(message = "ì²˜ë¦¬ ì¤‘...") {
    removeStatusUI();
    const container = document.createElement('div');
    container.id = 'status-container';
    container.innerHTML = `
        <span class="status-icon"><i class="fas fa-spinner fa-spin"></i></span>
        <span class="status-label">${escapeHtml(message)}</span>
    `;
    chatInputContainer.parentNode.insertBefore(container, chatInputContainer);
    scrollToBottom();
}
function removeStatusUI() {
    const el = document.getElementById('status-container');
    if (el) el.remove();
}

// --- Loading State ---
function setLoadingState(isLoading, statusMessage = "ì²˜ë¦¬ ì¤‘...") {
    userInput.disabled = isLoading;
    sendButton.disabled = isLoading;

    if (isLoading) {
        createStatusUI(statusMessage);
    } else {
        removeStatusUI();
        if (!userInput.disabled) {
            userInput.focus();
        }
    }
    scrollToBottom();
}

/* ======== PDF File Handling (Fetching Predefined File) ======== */

async function fetchAndUploadPredefinedPdf(pdfFilename) {
    if (uploadedFileUri && lastUploadedPdfName === pdfFilename) {
         log(`Reusing previously uploaded URI for ${pdfFilename}: ${uploadedFileUri}`);
         return uploadedFileUri;
    }

    log(`Attempting to fetch predefined PDF: ${pdfFilename}`);
    log('fetchAndUploadPredefinedPdf - pdfFilename:', pdfFilename); // <-- ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ë¨
    setLoadingState(true, `ì‚¬ì „ ì •ì˜ëœ PDF ë¡œë“œ ì¤‘: ${pdfFilename}...`);

    let pdfBlob;
    try {
        const response = await fetch(pdfFilename);

        if (!response.ok) {
            let errorMsg = `HTTP error! Status: ${response.status}`;
             if (response.status === 404) {
                 errorMsg = `ì˜¤ë¥˜: PDF íŒŒì¼ '${pdfFilename}'ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. HTML íŒŒì¼ê³¼ ê°™ì€ ë””ë ‰í† ë¦¬ì— ìˆëŠ”ì§€, íŒŒì¼ ì´ë¦„ì´ ì •í™•í•œì§€, ì›¹ ì„œë²„ê°€ íŒŒì¼ì„ ì œê³µí•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`;
             } else if (response.status === 0) {
                 errorMsg = `ì˜¤ë¥˜: PDF íŒŒì¼ '${pdfFilename}' ë¡œë“œ ì‹¤íŒ¨. ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” CORS ì •ì±… ë•Œë¬¸ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ê°€ ì›¹ ì„œë²„ë¥¼ í†µí•´ ì œê³µë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš” (file:/// ê²½ë¡œ ì•„ë‹˜).`;
             }
            throw new Error(errorMsg);
        }

        pdfBlob = await response.blob();
        log(`Successfully fetched PDF: ${pdfFilename}, Size: ${pdfBlob.size}, Type: ${pdfBlob.type}`);

        if (pdfBlob.size === 0) {
            throw new Error(`ì˜¤ë¥˜: ê°€ì ¸ì˜¨ PDF íŒŒì¼ '${pdfFilename}'ì˜ ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.`);
        }

    } catch (error) {
        log(`Error fetching predefined PDF '${pdfFilename}':`, error);
        addErrorMessage(`ì‚¬ì „ ì •ì˜ëœ PDF ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
        setLoadingState(false);
        return null;
    }

    try {
        const pdfFileObject = new File([pdfBlob], pdfFilename, { type: pdfBlob.type || 'application/pdf' });
        const fileUri = await uploadPdfToGeminiInternal(pdfFileObject);

        if (fileUri) {
             lastUploadedPdfName = pdfFilename;
        } else {
             lastUploadedPdfName = null;
        }
        return fileUri;

    } catch (error) {
       log("Error during upload after fetching:", error);
       lastUploadedPdfName = null;
       setLoadingState(false);
       return null;
    }
}


/* ======== GEMINI API INTERACTION (using REST API) ======== */

async function uploadPdfToGeminiInternal(fileObject) {
    if (!fileObject) return null;

    const fileName = fileObject.name || 'predefined.pdf';
    log(`Uploading PDF data for: ${fileName}`);
    log('uploadPdfToGeminiInternal - fileName:', fileName); // <-- ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ë¨
    setLoadingState(true, `Gemini APIë¡œ PDF ì—…ë¡œë“œ ì¤‘: ${fileName}...`);

    const uploadUrl = `https://generativelanguage.googleapis.com/upload/v1beta/files?key=${geminiApiKey}`;

    try {
        const response = await fetch(uploadUrl, {
            method: 'POST',
            headers: {
                'Content-Type': fileObject.type || 'application/pdf',
                'X-Goog-Upload-File-Name': encodeURIComponent(fileName)
            },
            body: fileObject
        });

        const data = await response.json();

        if (!response.ok || data.error) {
            let errorMsg = `File API Error: ${data.error?.message || `HTTP ${response.status}`}`;
            if (data.error?.details) {
                 try { errorMsg += ` Details: ${JSON.stringify(data.error.details)}`; } catch { /* ignore stringify error */ }
            }
             if (response.status === 403) {
                 errorMsg += ' (Permission Denied - Check API Key permissions and ensure File API is enabled for the key)';
             }
            throw new Error(errorMsg);
        }

        const uploadedFile = data.file || data;
        if (!uploadedFile || !uploadedFile.uri) {
            console.error("Unexpected upload response structure:", data);
            throw new Error("File API Error: Upload response did not contain expected file URI.");
        }

        log(`PDF Uploaded Successfully. URI: ${uploadedFile.uri}`);
        uploadedFileUri = uploadedFile.uri;
        return uploadedFileUri;

    } catch (error) {
        log('PDF Upload Error:', error);
        addErrorMessage(`PDF íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨ (${fileName}): ${error.message}. CORS, API í‚¤, ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
        uploadedFileUri = null;
        return null;
    }
}

async function getGeminiResponsePdf(question, fileUri) {
    if (!geminiApiKey) return "ì˜¤ë¥˜: Gemini API í‚¤ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.";
    if (!fileUri) return "ì˜¤ë¥˜: PDF íŒŒì¼ URIê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.";

    log(`Sending request to Gemini with PDF URI: ${fileUri} and Question: ${question}`);
    setLoadingState(true, "Gemini ë¶„ì„ ì¤‘...");

    const systemPrompt = `ë‹¹ì‹ ì€ "${PREDEFINED_PDF_FILENAME}" PDF ë¬¸ì„œì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— í•œêµ­ì–´ë¡œ ë‹µë³€í•˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
- ì œê³µëœ PDF íŒŒì¼("fileData")ì˜ ë‚´ìš©ì„ ë¶„ì„í•˜ê³  ì‚¬ìš©ìì˜ ì§ˆë¬¸("text")ì— ë‹µí•˜ì„¸ìš”.
- ë‹µë³€ì€ ë°˜ë“œì‹œ PDF íŒŒì¼ ë‚´ì˜ ì •ë³´ì— ê·¼ê±°í•´ì•¼ í•©ë‹ˆë‹¤. íŒŒì¼ì— ì—†ëŠ” ë‚´ìš©ì€ ë‹µë³€í•˜ì§€ ë§ˆì„¸ìš”.
- ë‹µë³€ì€ ëª…í™•í•˜ê³  ê°„ê²°í•˜ê²Œ, ì „ë¬¸ê°€ì ì¸ í†¤ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
- Markdown í˜•ì‹ì„ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤(êµµê²Œ, ê¸°ìš¸ì„, ëª©ë¡ ë“±).`;

    const reqBody = {
        contents: [{
            role: "user",
            parts: [
                { text: `${systemPrompt}\n\nì§ˆë¬¸: ${question}` },
                { fileData: { mimeType: "application/pdf", fileUri: fileUri } }
            ]
        }],
        safetySettings: [
             { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
             { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
             { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
             { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
        ],
        generationConfig: { temperature: 0.6 }
    };

    const model = "gemini-2.5-pro-exp-03-25";
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${geminiApiKey}`;

    try {
        const resp = await fetch(url, {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(reqBody)
        });
        const data = await resp.json();

        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        //       Geminië¡œë¶€í„° ë°›ì€ ì „ì²´ ì‘ë‹µ ë°ì´í„°ë¥¼ ë¡œê·¸ë¡œ ì¶œë ¥ (ì¶”ê°€ë¨)
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        console.log(">>> Full Gemini Response Data:", JSON.stringify(data, null, 2)); // ê°ì²´ êµ¬ì¡°ë¥¼ ë³´ê¸° ì¢‹ê²Œ ì¶œë ¥

        // --- Detailed Error Handling ---
        if (!resp.ok || data.error) {
            let errorDetail = data.error ? data.error.message : `HTTP ${resp.status}`;
            if (data.error?.details) {
                 try { errorDetail += ` Details: ${JSON.stringify(data.error.details)}`; } catch { /* ignore error */ }
            }
            if (errorDetail.includes("API key not valid") || errorDetail.includes("API_KEY_INVALID")) {
                errorDetail = "ì˜ëª»ëœ Gemini API í‚¤ì…ë‹ˆë‹¤. config.jsë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            } else if (resp.status === 403) { // Use resp.status here
                errorDetail += " (ê¶Œí•œ ë¬¸ì œ - API í‚¤ ê¶Œí•œ í™•ì¸ í•„ìš”)";
            } else if (resp.status === 400) { // Use resp.status here
                 errorDetail += " (ì˜ëª»ëœ ìš”ì²­ - ìš”ì²­ ë³¸ë¬¸ í™•ì¸ í•„ìš”)";
             }
            throw new Error(`Gemini API ì˜¤ë¥˜: ${errorDetail}`);
        }
        if (!data.candidates || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0].text) {
             let reason = "ì•Œ ìˆ˜ ì—†ëŠ” ì´ìœ .";
             if (data.promptFeedback && data.promptFeedback.blockReason) {
                  reason = `í”„ë¡¬í”„íŠ¸ ì°¨ë‹¨ë¨: ${data.promptFeedback.blockReason}`;
              } else if (data.candidates && data.candidates[0].finishReason) {
                  reason = `ì™„ë£Œ ì‚¬ìœ : ${data.candidates[0].finishReason}`;
                  if (data.candidates[0].safetyRatings) {
                      try { reason += ` ì•ˆì „ ë“±ê¸‰: ${JSON.stringify(data.candidates[0].safetyRatings)}`; } catch {}
                  }
              }
             log("Gemini ì‘ë‹µ ë‚´ìš©ì´ ì—†ê±°ë‚˜ ì°¨ë‹¨ë¨. ì‚¬ìœ :", reason, "ì „ì²´ ì‘ë‹µ:", data);
             return `ì˜¤ë¥˜: Geminië¡œë¶€í„° ë¹„ì–´ ìˆê±°ë‚˜ ì°¨ë‹¨ëœ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤. (${reason})`;
        }
        // --- End Error Handling ---


        // ì´ì œ í…ìŠ¤íŠ¸ ì ‘ê·¼ ì‹œë„ (ì—¬ê¸°ì„œ ì˜¤ë¥˜ê°€ ë‚  ìˆ˜ ìˆìŒ)
        let answer = data.candidates[0].content.parts[0].text;

        log("Geminië¡œë¶€í„° PDF ê¸°ë°˜ ì‘ë‹µ ìˆ˜ì‹  ì™„ë£Œ."); // ì´ ë¡œê·¸ëŠ” ì°í˜

        console.log(">>> Gemini Raw Answer:", answer); // ì´ ë¡œê·¸ëŠ” ì•ˆ ì°í˜”ì—ˆìŒ (ì´ì œ í™•ì¸ ê°€ëŠ¥)

        // --- Markdown to HTML ---
        answer = answer
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/^###+\s+(.*)/gm, '<h5>$1</h5>')
            .replace(/^##\s+(.*)/gm, '<h4>$1</h4>')
            .replace(/^#\s+(.*)/gm, '<h3>$1</h3>')
            .replace(/^\s*[\-\*]\s+(.*)/gm, '<li>$1</li>')
            .replace(/(<li>.*<\/li>\s*)+/g, '<ul>$&</ul>')
            .replace(/\n/g, '<br>')
            .replace(/<\/ul><br>/g, '</ul>')
            .replace(/<br><ul>/g, '<ul>')
            .replace(/<li><br>/g, '<li>')
            .replace(/<br><\/li>/g, '</li>');

        log(">>> Answer after Markdown conversion:", answer); // <-- ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€ë¨
        return answer;

    } catch (err) {
        log('Gemini API fetch error:', err);
        addErrorMessage(`Gemini í†µì‹  ì˜¤ë¥˜: ${err.message}`);
        return null; // Indicate failure
    }
}

/* ======== MAIN MESSAGE PROCESSING ======== */
async function processMessage() {
    const userQuestion = userInput.value.trim();
    if (!userQuestion) return;

    addUserMessage(userQuestion);
    userInput.value = '';
    userInput.blur();

    setLoadingState(true, "ì‘ì—… ì¤€ë¹„ ì¤‘...");

    try {
        const currentFileUri = await fetchAndUploadPredefinedPdf(PREDEFINED_PDF_FILENAME);

        if (!currentFileUri) {
            setLoadingState(false);
            return;
        }

        const botResponse = await getGeminiResponsePdf(userQuestion, currentFileUri);

        if (botResponse !== null) {
            if (botResponse.startsWith("ì˜¤ë¥˜:")) {
                addErrorMessage(botResponse.replace(/^ì˜¤ë¥˜:\s*/, ''));
            } else {
                addBotMessage(botResponse);
            }
        }

    } catch (error) {
       log("Unexpected error in processMessage:", error);
       addErrorMessage(`ì²˜ë¦¬ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
    } finally {
        setLoadingState(false);
    }
}

/* ======== EVENT LISTENERS ======== */
function handleSend() {
    const msg = userInput.value.trim();
    if (!sendButton.disabled && msg) {
        processMessage();
    } else if (!msg) {
        addErrorMessage("ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    }
}

sendButton.addEventListener('click', handleSend);

userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
    }
});

// --- Initial Setup ---
userInput.focus();
log(`ì‚¬ì „ ì •ì˜ëœ PDF ë´‡ ì´ˆê¸°í™” ì™„ë£Œ. ì‚¬ìš©í•  PDF: ${PREDEFINED_PDF_FILENAME}. ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.`);

</script>
</body>
</html>
